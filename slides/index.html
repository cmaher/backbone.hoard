<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">

  <title>Backbone.Hoard - XHR Consolidation and Configurable Caching</title>

  <meta name="description" content="Stop making duplicate requests with backbone.hoard">
  <meta name="author" content="Christian Maher">

  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

  <link rel="stylesheet" href="css/reveal.css">
  <link rel="stylesheet" href="css/theme/black.css" id="theme">
  <link rel="stylesheet" href="css/hoard.css">

  <!-- Code syntax highlighting -->
  <link rel="stylesheet" href="lib/css/zenburn.css">

  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
    document.getElementsByTagName('head')[0].appendChild(link);
  </script>

  <!--[if lt IE 9]>
  <script src="lib/js/html5shiv.js"></script>
  <![endif]-->
</head>

<body>

<div class="reveal">

  <!-- Any section element inside of this demo-container is displayed as a slide -->
  <div class="slides">
    <section>
      <h1>Backbone.Hoard</h1>

      <h3 class="fragment">XHR Consolidation <span class="fragment">and Caching</span></h3>
      <h5>for Backbone.js</h5>
      <p>
        <small>
          <a href="https://github.com/cmaher">Christian Maher</a> /
          <a href="http://twitter.com/christiansmaher">@christiansmaher</a>
        </small>
      </p>

      <p>
        <small>
          <a href="http://conductor.github.io/backbone.hoard/slides">conductor.github.io/backbone.hoard/slides</a>
        </small>
      </p>

      <aside class="notes">
        <ul>
          <li>Backbone's goal is to be minimal</li>
          <li>Marionette simplifies view management</li>
          <li>Hoard simplifies how you handle your data</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>Use Cases</h2>

      <ul>
        <li class="fragment">Dashboard Applications (XHR Consolidation)</li>
        <li class="fragment">Route-Specific Data (Caching)</li>
      </ul>

      <aside class="notes">
        <ul>
          <li>Dashboards benefit from XHR Consolidation</li>
          <li>Routing benefits from caching</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>What does this look like?</h2>
      <iframe width="60%" height="300" src="//jsfiddle.net/cmaher/b5bk5vbx/embedded/result" allowfullscreen="allowfullscreen" frameborder="0"></iframe>
      <aside class="notes">
        <ul>
          <li>Clicking things without enabling Hoard demonstrates unconsolidated, uncached fetches</li>
        </ul>
      </aside>
    </section>

    <section>
      <section>
        <h2>Dashboard Applications</h2>

        <div class="demo-container">
          <div class="demo workspace">
            <div class="widget-row">
              <div class="widget widget-1">/models</div>
              <div class="widget widget-2">/models/1</div>
            </div>
            <div class="widget-row">
              <div class="widget widget-3">/models/2</div>
              <div class="widget widget-4">/models/3</div>
            </div>
          </div>
        </div>

        <aside class="notes">
          <strong>NAVIGATE DOWN</strong>
          <ul>
            <li>fetching 4 different things</li>
            <li>Dashboard App: An app featuring custom reports created by the user</li>
            <li>data loaded on page load</li>
            <li>user-controlled data === complexity</li>
            <li>Dashboards benefit from XHR consolidation</li>
          </ul>
        </aside>
      </section>

      <section>
        <h2>Dashboard Applications</h2>

        <div class="demo-container">
          <div class="demo workspace">
            <div class="widget-row">
              <div class="widget widget-1">/models</div>
              <div class="widget widget-2">/models/1</div>
            </div>
            <div class="widget-row">
              <div class="widget widget-2">/models/1</div>
              <div class="widget widget-1">/models</div>
            </div>
          </div>
        </div>

        <aside class="notes">
          <strong>NAVIGATE DOWN</strong>
          <ul>
            <li>fetching 2 different things twice each</li>
            <li>Dashboard App: An app featuring custom reports created by the user</li>
            <li>data loaded on page load</li>
            <li>user-controlled data === complexity</li>
            <li>Dashboards benefit from XHR consolidation</li>
          </ul>
        </aside>
      </section>

      <section>
        <h2>Dashboard Applications</h2>

        <div class="demo-container">
          <div class="demo workspace">
            <div class="widget-row">
              <div class="widget widget-1">/models</div>
              <div class="widget widget-1">/models</div>
            </div>
            <div class="widget-row">
              <div class="widget widget-1">/models</div>
              <div class="widget widget-1">/models</div>
            </div>
          </div>
        </div>

        <aside class="notes">
          <strong>NAVIGATE RIGHT</strong>
          <ul>
            <li>fetching the same (potentially expensive) thing again and again...</li>
            <li>Dashboard App: An app featuring custom reports created by the user</li>
            <li>data loaded on page load</li>
            <li>user-controlled data === complexity</li>
            <li>Dashboards benefit from XHR consolidation</li>
            <li>Hoard lets us make multiple fetch calls all at the same time and only make one real XHR</li>
          </ul>
        </aside>
      </section>
    </section>

    <section>
      <h2>XHR Consolidation</h2>
      <p>Prevent multiple simultaneous requests to the same endpoint</p>
    </section>

    <section>
      <h2>XHR Consolidation</h2>
      <h5>Setup Hoard</h5>
<pre><code class="javascript">var cacheControl = new Backbone.Hoard.Control();
var MyModel = Backbone.Model.extend({
  url: function () { return '/models/' + this.id; },
  sync: cacheControl.getModelSync()
});

var model1 = new MyModel({ id: 1 });
var model2 = new MyModel({ id: 1 });
</code></pre>

      <aside class="notes">
        <ul>
          <li>url used for data access and cache key</li>
          <li>control + getModelSync === entry point for Hoard</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>XHR Consolidation</h2>
      <h5>In Action</h5>
<pre><code class="javascript">Promise.all([model1.fetch(), model2.fetch()]).then(function () {
  // only 1 ajax request has been made
  doStuff();
});</code></pre>

      <aside class="notes">
        <ul>
          <li>XHR Consolidation -- Don't make multiple of the same request at the same time</li>
          <li>Hoard sees mulitple requests for the same URL at the same time</li>
        </ul>
      </aside>
    </section>

    <!--<section>-->
      <!--<h2>Configurable Caching</h2>-->
<!--<pre><code class="javascript">var MyModel = Backbone.Model.extend({-->
  <!--url: function () { return '/models/' + this.id; }-->
<!--});-->

<!--Backbone.Hoard.backend = localStorage;-->
<!--var localControl = new Backbone.Hoard.Control();-->
<!--var LocalModel = MyModel.extend({-->
  <!--sync: localControl.getModelSync()-->
<!--});-->

<!--var sessionControl = new Backbone.Hoard.Control({-->
  <!--backend: sessionStorage-->
<!--});-->
<!--var SessionModel = MyModel.extend({-->
  <!--sync: sessionControl.getModelSync()-->
<!--});</code></pre>-->

      <!--<aside class="notes">-->
        <!--<ul>-->
          <!--<li>Configure Cache backing on a per-control basis</li>-->
        <!--</ul>-->
      <!--</aside>-->
    <!--</section>-->

    <section>
      <section>
        <h2>Route-Specific Data</h2>

        <div class="demo-container">
          <div class="demo routing">
            <p class="address-bar">/users</p>

            <div class="routing-app">
              <ul class="users-list">
                <li><a href="#/7">Users</a></li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-now.jpg">
                  <a href="#/7/1" class="user-link">cmaher (now)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-then.jpg">
                  <a href="#/7/2" class="user-link">cmaher (then)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/sloth.jpg">
                  <a href="#/7/3" class="user-link">sloth</a>
                </li>
              </ul>
              <div class="users-details">
                Select a User
              </div>
            </div>
          </div>
        </div>

        <aside class="notes">
          <strong>CLICKABLE</strong>
          <ul>
            <li>Caching</li>
            <li>Each Route can require distinct data</li>
            <li>
              <p>When going to a new route (without hoard)</p>
              <ul>
                <li>Check to see if we have the data</li>
                <li>If no data: fetch and render when ready</li>
                <li>If data: render</li>
              </ul>
            </li>
            <li>
              <p>
                When going to a new route (with hoard)
              </p>
              <ul>
                <li>Fetch and render (always)</li>
                <li>
                  <p>Isomorphic Style</p>
                  <ul>
                    <li>NOT as in Isomorphic client/server JS</li>
                    <li>Isomorphic as in code is written the same way regardless of state</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </aside>
      </section>

      <section>
        <h2>Route-Specific Data</h2>

        <div class="demo-container">
          <div class="demo routing">
            <p class="address-bar">/users/1</p>

            <div class="routing-app">
              <ul class="users-list">
                <li><a href="#/7">Users</a></li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-now.jpg">
                  <a href="#/7/1" class="user-link">cmaher (now)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-then.jpg">
                  <a href="#/7/2" class="user-link">cmaher (then)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/sloth.jpg">
                  <a href="#/7/3" class="user-link">sloth</a>
                </li>
              </ul>
              <div class="users-details">
                <img class="avatar" src="./images/cmaher-now.jpg">

                <p>Christian (now)</p>

                <p>Following</p>
                <ul>
                  <li><a href="#/7/3" class="user-link">Space Sloth</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Route-Specific Data</h2>

        <div class="demo-container">
          <div class="demo routing">
            <p class="address-bar">/users/2</p>

            <div class="routing-app">
              <ul class="users-list">
                <li><a href="#/7">Users</a></li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-now.jpg">
                  <a href="#/7/1" class="user-link">cmaher (now)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-then.jpg">
                  <a href="#/7/2" class="user-link">cmaher (then)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/sloth.jpg">
                  <a href="#/7/3" class="user-link">sloth</a>
                </li>
              </ul>
              <div class="users-details">
                <img class="avatar" src="./images/cmaher-then.jpg">

                <p>Christian (then)</p>

                <p>Following</p>
                <ul>
                  <li><a href="#/7/1" class="user-link">Christian (now)</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section>
        <h2>Route-Specific Data</h2>

        <div class="demo-container">
          <div class="demo routing">
            <p class="address-bar">/users/3</p>

            <div class="routing-app">
              <ul class="users-list">
                <li><a href="#/7">Users</a></li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-now.jpg">
                  <a href="#/7/1" class="user-link">cmaher (now)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/cmaher-then.jpg">
                  <a href="#/7/2" class="user-link">cmaher (then)</a>
                </li>
                <li class="user">
                  <img class="avatar" src="./images/sloth.jpg">
                  <a href="#/7/3" class="user-link">sloth</a>
                </li>
              </ul>
              <div class="users-details">
                <img class="avatar" src="./images/sloth.jpg">

                <p>Space Sloth</p>

                <p>Following</p>
                <ul>
                  <li><a href="#/7/1" class="user-link">Christian (now)</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <section>
      <h2>Caching</h2>
      <p>Prevent a request to an endpoint if that endpoint has been requested before</p>
    </section>

    <!--<section>-->
      <!--<h2>Caching</h2>-->
      <!--<h5>Setup Hoard</h5>-->
<!--<pre><code class="javascript">var cacheControl = new Backbone.Hoard.Control();-->
<!--var MyModel = Backbone.Model.extend({-->
  <!--url: function () { return '/models/' + this.id; },-->
  <!--sync: cacheControl.getModelSync()-->
<!--});-->

<!--var model1 = new MyModel({ id: 1 });-->
<!--var model2 = new MyModel({ id: 1 });-->
<!--</code></pre>-->

      <!--<aside class="notes">-->
        <!--<ul>-->
          <!--<li>Same setup as before (yay)</li>-->
        <!--</ul>-->
      <!--</aside>-->
    <!--</section>-->

    <!--<section>-->
      <!--<h2>Caching</h2>-->
<!--<pre><code class="javascript">model1.fetch().then(function () {-->
  <!--return model2.fetch();-->
<!--}).then(function () {-->
  <!--// Only 1 ajax request has been made-->
  <!--doStuff();-->
<!--});</code></pre>-->

      <!--<aside class="notes">-->
        <!--<ul>-->
          <!--<li>Caching -- Don't make a request if we've already made it</li>-->
          <!--<li>Hoard sees the cached value for the same url</li>-->
        <!--</ul>-->
      <!--</aside>-->
    <!--</section>-->

    <section>
      <h2>Caching Route-Specific Data</h2>
      <h3>Without Hoard</h3>
      <pre><code class="javascript">var routePromise;
var model = collection.get(modelId);
if (model) {
  routePromise = Promise.resolve();
} else {
  model = new MyModel({ id: modelId });
  collection.add(model);
  routePromise = model.fetch();
}
routePromise.then(function () {
  doRoute(model);
});</code></pre>

      <aside class="notes">
        <ul>
          <li>Tedious (can be encapsulated, but a lot to keep in head when overriding)</li>
          <li>Shared data between routes -- easy to corrupt</li>
          <li>Maybe in this case, the collection is only here as a manual cache -- heavy</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>Caching Route-Specific Data</h2>
      <h3>With Hoard</h3>
      <pre><code class="javascript">var model = new MyModel({ id: modelId });
model.fetch().then(function () {
  doRoute(model);
});</code></pre>

      <aside class="notes">
        <ul>
          <li>Same code every time</li>
          <li>
            <p>Same data, different model instance</p>
            <ul>
              <li>deliberate difference</li>
              <li>disposable models are powerful</li>
              <li>prevent memory leaks</li>
              <li>prevent event leaks</li>
              <li>prevent data corruption</li>
            </ul>
          </li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>What About...</h2>
      <ul>
        <li class="fragment">Dependency Injection</li>
        <li class="fragment">Existing Backbone Plugins</li>
        <li class="fragment">HTTP Headers</li>
      </ul>
    </section>

    <section>
      <h2>Dependency Injection</h2>
      <ul>
        <li class="fragment">Complicated events</li>
        <li class="fragment">Imperfect key generation</li>
        <li class="fragment">Multiple fetches on change</li>
      </ul>

      <aside class="notes">
        <ul>
          <li>This is what we originally did (PageDataProvider)</li>
          <li>Use initial attributes and options to retrieve same model instance</li>
          <li>Hard to reset listeners if the desired model changes</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>Existing Backbone Plugins</h2>
      <ul class="fragment">
        <li>backbone-fetch-cache</li>
        <li>backbone.cachingSync</li>
      </ul>

      <aside class="notes">
        <ul>
          <li>None of the above account for simultaneous requests (dashboard apps).</li>
          <li>Neither one provides async cache support (no indexeddb)</li>
          <li>Not as much configuration (fetch-cache supports custom keys and localStorage or no).</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>HTTP Headers</h2>
      <ul>
        <li class="fragment">cache-control</li>
        <li class="fragment">etag</li>
      </ul>

      <aside class="notes">
        <ul>
          <li>cache-control TTL doesn't offer as fine-grained control (great for files)</li>
          <li>ETags
            <ul>
              <li>better for data that cache-control</li>
              <li>still require a trip to the server</li>
              <li>better choice for longer-term caching</li>
            </ul>
          </li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>Advanced Use Cases</h2>
      <ul>
        <li class="fragment">Key Interpretation</li>
        <li class="fragment">Chunky Endpoints</li>
      </ul>
    </section>

    <section>
      <h2>Key Interpretation</h2>
      <ul>
        <li class="fragment">
          <p>Good RESTful APIs establish patterns</p>
          <ul>
            <li>?page=5</li>
            <li>?offset=100</li>
            <li>?filter="odd_id"</li>
            <li>?ids=1,2,3</li>
          </ul>
        </li>
        <li class="fragment">Developers can capture those patterns on the client</li>
      </ul>
    </section>

    <section>
      <h2>Key Interpretation</h2>
      <pre><code class="javascript">var coll = new MyCollection({ url: '/models' });
var filtered = new MyCollection({ url: '/models?filter="odd_id"' });
Promise.all([coll.fetch(), filtered.fetch()]).then(function () {
  // Only 1 ajax request has been made
  // coll has all models
  // filtered has all models with odd ids
});</code></pre>

      <aside class="notes">
        <ul>
          <li>Good RESTful APIs establish patterns</li>
          <li>Make it so Hoard uses these patterns to pick a more general URL and apply patterns</li>
          <li>Hoard can currently take advantage of this pattern</li>
          <li>Originally meant to build out separately, but works with custom keys and Backbone lifecycle</li>
          <li>Similar to GraphQL in problem that it's trying to address</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>Chunky Endpoints</h2>

      <ul>
        <li class="fragment">Contain potentially unrelated data</li>
        <li class="fragment">Require processing</li>
        <li class="fragment">Can be processed in different ways</li>
      </ul>

      <aside class="notes">
        <ul>
          <li>What is a "Chunky" endpoint?</li>
          <li>Came out of the community!!</li>
          <li>No one thing needs all calculated values</li>
          <li>Some calculated values are potentially expensive</li>
          <li>Working with poorly-factored (from the use perspective) endpoints</li>
          <li>Good when you don't have control of the endpoint (or it needs to be that way for performance reasons)</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>Chunky Endpoints</h2>
      <pre><code class="javascript">// response from /data.json
{
  "a": 1,
  "b": 2,
  "c": 3,
  // ...
}</code></pre>
    </section>

    <section>
      <h2>Chunky Endpoints</h2>

      <pre><code class="javascript">var ChunkModel = Backbone.Model.extend({
  url: '/data.json',
  sync: cacheControl.getModelSync()
});

var ModelOne = ChunkModel.extend({
  parse: function (data) {
    return { calculated: data.a + data.b }
  }
});

var ModelTwo = ChunkModel.extend({
  parse: function (data) {
    return { calculated: data.b * data.c }
  }
});</code></pre>

      <aside class="notes">
        <ul>
          <li>All models reference the same Endpoint</li>
          <li>Different parse methods</li>
          <li>Makes the client side feel clean despite the messy server side</li>
        </ul>
      </aside>
    </section>

    <section>
      <h2>Links</h2>
      <ul>
        <li><a href="https://github.com/Conductor/backbone.hoard">github.com/Conductor/backbone.hoard</a></li>
        <li><a href="https://gitter.im/cmaher/backbone.hoard">gitter.im/cmaher/backbone.hoard</a></li>
        <li>npm + bower: <span class="monospace-text">backbone.hoard</span></li>
      </ul>
    </section>
  </div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

  // Full list of configuration options available at:
  // https://github.com/hakimel/reveal.js#configuration
  Reveal.initialize({
    controls: true,
    progress: false,
    history: true,
    center: true,

    transition: 'none', // none/fade/slide/convex/concave/zoom

    // Optional reveal.js plugins
    dependencies: [
      {
        src: 'lib/js/classList.js', condition: function () {
        return !document.body.classList;
      }
      },
      {
        src: 'plugin/markdown/marked.js', condition: function () {
        return !!document.querySelector('[data-markdown]');
      }
      },
      {
        src: 'plugin/markdown/markdown.js', condition: function () {
        return !!document.querySelector('[data-markdown]');
      }
      },
      {
        src: 'plugin/highlight/highlight.js', async: true, condition: function () {
        return !!document.querySelector('pre code');
      }, callback: function () {
        hljs.initHighlightingOnLoad();
      }
      },
      { src: 'plugin/zoom-js/zoom.js', async: true },
      { src: 'plugin/notes/notes.js', async: true }
    ]
  });

</script>
<script type="text/javascript">
  var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
  document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
  try {
    var pageTracker = _gat._getTracker("UA-38761388-2");
    pageTracker._trackPageview();
  } catch (err) {
  }
</script>
</body>
</html>
